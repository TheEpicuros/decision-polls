# Decision Polls v1.2 Implementation Guide

This guide outlines the steps to implement the v1.2 branch with fixes for the custom endpoints and ranked polls display issues.

## 1. Branch Creation (Already Completed)

We've created the v1.2 branch with:
- Updated version number to 1.2.0
- Moved utility files to the tools directory
- Updated README.md

## 2. Ranked Polls Display Fix

The main issue identified is that ranked choice polls are not properly displaying the voted ranking. Instead, they show options ordered by vote count rather than by user-selected rank.

### Implementation Options

#### Option A: Direct Code Changes (Recommended)

Apply these changes directly to the files in your v1.2 branch:

1. **Modify `includes/core/models/class-vote.php`**:
   - In the `get_results` method (around line 171), change the query ordering to handle ranked polls differently
   - Add the poll_type to the returned results

   ```php
   // Change this:
   "SELECT r.*, a.answer_text FROM $results_table r
    JOIN $answers_table a ON r.answer_id = a.id
    WHERE r.poll_id = %d
    ORDER BY r.votes_count DESC, a.sort_order ASC"

   // To this:
   $order_by = ($poll['type'] === 'ranked') ? 'r.votes_count DESC' : 'r.votes_count DESC, a.sort_order ASC';
   "SELECT r.*, a.answer_text FROM $results_table r
    JOIN $answers_table a ON r.answer_id = a.id
    WHERE r.poll_id = %d
    ORDER BY $order_by"
   ```

   - Add 'poll_type' to the return array:
   ```php
   return array(
       'poll_id'      => (int) $poll_id,
       'poll_type'    => $poll['type'],  // Add this line
       'total_votes'  => (int) $total_votes,
       'results'      => $formatted_results,
       'last_updated' => !empty($results) ? $results[0]->last_calculated : current_time('mysql'),
   );
   ```

2. **Modify `templates/results.php`**:
   - Update the rank calculation logic (around line 99):
   ```php
   // Replace this:
   $rank_index = array_search($result, $results_data, true);

   // With this:
   $rank_index = isset($result['rank']) ? $result['rank'] - 1 : array_search($result, $results_data, true);
   ```

#### Option B: Use WordPress Filters (Alternative)

If you prefer not to modify core files directly, use the filter approach in `fixes/wp-standard-ranked-poll-fix.php`.

1. Create a new file `includes/filter-helpers.php`
2. Copy the code from `fixes/wp-standard-ranked-poll-fix.php`
3. Add the file to your plugin's initialization:

```php
// In decision-polls.php, add:
require_once DECISION_POLLS_PLUGIN_DIR . 'includes/filter-helpers.php';
Decision_Polls_Ranked_Fix::init();
```

## 3. Testing Procedure

After implementing the fixes:

1. **Test regular polls**:
   - Create a standard poll
   - Vote on it
   - Verify results display correctly

2. **Test ranked polls**:
   - Create a ranked choice poll with at least 3 options
   - Vote on it, carefully ranking your choices
   - Verify that the results page shows the options in the correct ranked order
   - Verify that the "1st choice", "2nd choice" labels appear correctly

3. **Test endpoint navigation**:
   - Verify that `/poll/[id]/` URLs work correctly
   - Verify that `/poll/[id]/results/` URLs show results correctly
   - Test the "Create a Poll" link

## 4. Push to GitHub

Once testing is complete:

```bash
git add .
git commit -m "Fix ranked polls display issues"
git push -u origin v1.2
```

## 5. Further UI Improvements

For further UI improvements (in separate commits):

1. **Poll Container Width**:
   - Add CSS to ensure polls display at full width
   - Consider responsive design improvements

2. **Theme Compatibility**:
   - Add CSS to handle different theme contexts
   - Ensure proper padding and margins

These can be implemented after confirming the basic functionality fixes.
